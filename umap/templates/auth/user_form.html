{% extends "umap/content.html" %}

{% load i18n static %}

{% block head_title %}
  {% translate "My Profile" %} - {{ SITE_DESCRIPTION }}
{% endblock head_title %}
{% block maincontent %}
  {% include "umap/dashboard_menu.html" with selected="profile" %}
  <div class="wrapper">
    <div class="row">
      {% if form.non_field_errors %}
        <ul class="form-errors">
          {% for error in form.non_field_errors %}
            <li>
              {{ error }}
            </li>
          {% endfor %}
        </ul>
      {% endif %}
      <form id="user_form" method="post">
        {% csrf_token %}
        {{ form }}
        <input type="submit" value="{% trans "Save" %}" />
      </form>
      <div class="row">
        <button id="profile-simplified-toggle" data-default="{{ SIMPLIFIED_MODE|yesno:'true,false' }}" class="fr-btn fr-btn--secondary" type="button">{% trans "Toggle simplified mode" %}</button>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          var btn = document.getElementById('profile-simplified-toggle')
          if (!btn) return
          var stored = localStorage.getItem('simplified_mode')
          var initial = stored === null ? (btn.dataset.default === 'true') : (stored === 'true')
          document.body.classList.toggle('simplified-mode', initial)
          btn.addEventListener('click', function () {
            var current = document.body.classList.contains('simplified-mode')
            var next = !current
            document.body.classList.toggle('simplified-mode', next)
            localStorage.setItem('simplified_mode', next ? 'true' : 'false')
            // Persist to server session
            fetch('{% url "simplified_mode_set" %}', {
              method: 'POST',
              credentials: 'same-origin',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': (document.cookie.match(/(^|;)\s*csrftoken=([^;]+)/)||[])[2]||'',
                'Accept': 'application/json'
              },
              body: JSON.stringify({simplified: next})
            }).then(function (r) { return r.json() }).then(function (data) {
              console.log('Profile toggle persisted to session, simplified_mode=', data.simplified)
            }).catch(function (err) { console.log('Failed to persist simplified mode to session', err) })
            console.log('Profile toggle clicked, simplified_mode=', next)
          })
        })
      </script>
    </div>
    {% if backends.backends|length %}
      <div class="row">
        <h3>
          {% trans "Your current providers" %}
        </h3>
        <ul class="login-grid block-grid">
          {% for name in providers %}
            <li>
              {% with "umap/img/providers/"|add:name|add:".png" as path %}
               <img src="{% static path %}" width="92px" height="92px" alt="{{ name }}" />
              {% endwith %}
            </li>
          {% endfor %}
        </ul>
      </div>
      <div class="row">
        <h3>
          {% trans "Connect to another provider" %}
        </h3>
        <p>
          {% blocktrans %}It's a good habit to connect your account to more than one provider, in case one provider becomes unavailable, temporarily or even permanently.{% endblocktrans %}
        </p>
        <div>
          <ul class="login-grid block-grid">
            {% for name in backends.backends %}
              {% if name not in providers %}
                <li>
                  {% include "umap/components/provider.html" with name=name %}
                </li>
              {% endif %}
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endif %}
  </div>
{% endblock maincontent %}
