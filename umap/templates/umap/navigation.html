{% load i18n %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
      var currentUrl = new URL(window.location.href);
      var currentPath = currentUrl.origin + currentUrl.pathname;
      var navbar = document.querySelector(".fr-nav__list");
      var navItems = navbar.querySelectorAll(".fr-nav__item");
      
      // Function to normalize path by removing trailing slash and extra segments
      function normalizePath(path) {
          // Remove trailing slash
          if (path.endsWith('/')) {
              path = path.slice(0, -1);
          }
          return path;
      }
      
      navItems.forEach(function (item) {
          var link = item.querySelector(".fr-nav__link");
          if (!link) return;
          
          var linkUrl = new URL(link.href);
          var linkPath = linkUrl.origin + linkUrl.pathname;
          
          // Normalize both paths for comparison
          var normalizedCurrentPath = normalizePath(currentPath);
          var normalizedLinkPath = normalizePath(linkPath);
          
          // Check if current path starts with the link path (for sub-pages)
          // But avoid matching root/index with everything
          if (normalizedCurrentPath === normalizedLinkPath) {
              // If link is just the origin (root/index), only match if current path is also root
              var linkUrl = new URL(link.href);
              if (linkUrl.pathname === '/' || linkUrl.pathname === '') {
                  // Root link should only match root path
                  if (currentUrl.pathname === '/' || currentUrl.pathname === '') {
                      link.setAttribute("aria-current", "page");
                  }
              } else {
                  // Non-root links can match their sub-paths
                  link.setAttribute("aria-current", "page");
              }
          }
      });
  });
</script>


<header role="banner" class="fr-header">
  <div class="fr-header__body">
    <div class="fr-container">
      <div class="fr-header__body-row">
        <div class="fr-header__brand fr-enlarge-link">
          <div class="fr-header__brand-top">
            <div class="fr-header__logo">
              <p class="fr-logo">
                MINISTÈRES<br />
                TRANSITION ÉCOLOGIQUE<br />
                AMÉNAGEMENT DU TERRITOIRE<br />
                TRANSPORTS<br />
                VILLE ET LOGEMENT
              </p>
            </div>
            <div class="fr-header__navbar">
              <button class="fr-btn--menu fr-btn"
                      data-fr-opened="false"
                      aria-controls="modal-499"
                      aria-haspopup="menu"
                      id="button-500"
                      title="Menu">Menu</button>
            </div>
          </div>
          <div class="fr-header__service">
            <a href="{% url 'home' %}"
               title="Accueil - [Outil de visualisation - Rafraîchissement des villes] - Ministères Aménagement du territoire et Transition écologique">
              <p class="fr-header__service-title">Outil de visualisation - Rafraîchissement des villes</p>
            </a>
            <p class="fr-header__service-tagline">Preuve de Concept</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="fr-header__menu fr-modal"
       id="modal-499"
       aria-labelledby="button-500">
    <div class="fr-container">
      <button class="fr-btn--close fr-btn" aria-controls="modal-499" title="Fermer">Fermer</button>
      <div class="fr-header__menu-links"></div>
    </div>
  </div>

  <!-- DSFR Navigation menu -->
  <div class="fr-header__menu fr-nav" id="header-navigation" role="navigation" aria-label="{% trans 'Main menu' %}">
    <div class="fr-container">
      <ul class="fr-nav__list">
        <!-- Home -->
        <li class="fr-nav__item">
          <a class="fr-nav__link" href="{% url 'home' %}">{% trans 'Home' %}</a>
        </li>

        <!-- Authenticated user links -->
        {% if user.is_authenticated %}
          <li class="fr-nav__item">
            <a class="fr-nav__link" href="{% url 'user_dashboard' %}">{% trans 'My Dashboard' %} ({{ user }})</a>
          </li>
          <li class="fr-nav__item">
            <a class="fr-nav__link" href="{{ user.get_stars_url }}">{% trans 'Starred maps' %}</a>
          </li>
        {% else %}
          <li class="fr-nav__item">
            <a id="nav-login-link" class="fr-nav__link" href="{% url 'login' %}">{% trans 'Log in' %}</a>
          </li>
        {% endif %}

        {% if UMAP_HELP_URL %}
          <li class="fr-nav__item">
            <a class="fr-nav__link" href="{{ UMAP_HELP_URL }}">{% trans 'Help' %}</a>
          </li>
        {% endif %}

        <!-- Account settings -->
        {% if user.is_authenticated %}
          {% if user.has_usable_password %}
            <li class="fr-nav__item">
              <a class="fr-nav__link" href="{% url 'password_change' %}">{% trans 'Change password' %}</a>
            </li>
          {% endif %}
          <li class="fr-nav__item">
            <a class="fr-nav__link" href="{% url 'logout' %}">{% trans 'Log out' %}</a>
          </li>
        {% endif %}

      </ul>
    </div>
  </div>
</header>
<br />
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var btn = document.getElementById('simplified-toggle')
    if (!btn) return

    // Initialize from localStorage, fallback to server default stored on the button
    var stored = localStorage.getItem('simplified_mode')
    var initial = null
    if (stored === null) {
      initial = btn.dataset.default === 'true'
    } else {
      initial = stored === 'true'
    }
    btn.setAttribute('aria-pressed', initial ? 'true' : 'false')
    document.body.classList.toggle('simplified-mode', !!initial)

    btn.addEventListener('click', function () {
      var current = btn.getAttribute('aria-pressed') === 'true'
      // Toggle class and use returned value as new state
      var next = document.body.classList.toggle('simplified-mode')
      btn.setAttribute('aria-pressed', next ? 'true' : 'false')
      localStorage.setItem('simplified_mode', next ? 'true' : 'false')
      // Persist to server session
      fetch('{% url "simplified_mode_set" %}', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': (document.cookie.match(/(^|;)\s*csrftoken=([^;]+)/)||[])[2]||'',
          'Accept': 'application/json'
        },
        body: JSON.stringify({simplified: next})
      }).then(function (r) { return r.json() }).then(function (data) {
        console.log('Simplified mode persisted to session, server state=', data.simplified)
        // reload the page to apply changes
        location.reload()
      }).catch(function (err) { console.log('Failed to persist simplified mode to session', err) })
      
    })
  })
</script>