{% extends "umap/content.html" %}

{% load umap_tags i18n static %}

{% block messages %}
  {# We don't want maps in the list to display errors. #}
{% endblock messages %}
{% block maincontent %}
  <!-- <button id="start-tutorial-btn" class="fr-btn fr-btn--tertiary">{% trans 'Start tutorial' %}</button>
  <div class="mt-2">
    <button id="simplified-toggle" class="fr-btn fr-btn--secondary" data-default="{{ SIMPLIFIED_MODE|yesno:'true,false' }}" aria-pressed="false">{% trans 'Simplified' %}</button>
    <span id="simplified-status">{% if SIMPLIFIED_MODE %}{{ 'Simplified mode is ON' }}{% else %}{{ 'Simplified mode is OFF' }}{% endif %}</span>
  </div>-->
  {% include "umap/search_bar.html" %}
  {% include "umap/about_summary.html" %}
  {% if showcase_map %}
    <div class="wrapper showcase-map">
      <h2 class="section">
        {% blocktrans %}Map of the uMaps{% endblocktrans %}
      </h2>
      <div class="row">
        {% map_fragment showcase_map zoomControl=1 %}
      </div>
    </div>
  {% endif %}
  <div class="wrapper">
    {% if maps %}
      <div class="row">
        <h2 class="section">
          {% blocktrans %}Get inspired, browse maps{% endblocktrans %}
        </h2>
        <div class="grid-container">
          {% include "umap/map_list.html" %}
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Modal DSFR pour le choix du tutoriel -->
  <dialog id="tutorial-choice-modal" class="fr-modal" aria-labelledby="tutorial-choice-modal-title" aria-modal="true">
    <div class="fr-container fr-container--fluid">
      <div class="fr-grid-row fr-grid-row--center">
        <div class="fr-col-12 fr-col-md-11 fr-col-lg-10">
          <div class="fr-modal__body">
            <div class="fr-modal__header">
              <button class="fr-btn--close fr-btn" aria-controls="tutorial-choice-modal" title="Fermer" type="button">Fermer</button>
            </div>
            <div class="fr-modal__content">
              <h1 id="tutorial-choice-modal-title" class="fr-modal__title">
                Cr√©er une nouvelle carte
              </h1>
              <p>Souhaitez-vous √™tre guid√© dans la cr√©ation de votre carte ?</p>
            </div>
            <div class="fr-modal__footer">
              <ul class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg">
                <li>
                  <button id="create-without-tutorial" class="fr-btn fr-btn--lg" type="button">
                    üöÄ Cr√©er sans parcours guid√©
                  </button>
                </li>
                <li>
                  <button id="create-with-tutorial" class="fr-btn fr-btn--primary fr-btn--lg" type="button">
                    üéì Cr√©er avec un parcours guid√©
                  </button>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </dialog>
  
{% endblock maincontent %}



{% block bottom_js %}
  {{ block.super }}
  <script type="module">

    console.log("home: tutorial module loading")

    import Tutorial from '{% static "umap/js/components/tutorial.js" %}'

    console.log('home: tutorial module imported')

    document.addEventListener('DOMContentLoaded', () => {
      console.log('home: DOMContentLoaded (tutorial init)')
      const steps = [
              { 
                selector: '', 
                title: 'Tutoriel : Connexion et cr√©ation de carte', 
                text: `
                Bienvenue sur l'outil de visualisation et de cr√©ation de cartes li√© √† la th√©matique du rafra√Æchissement des villes.
                </br></br>

                Dans ce tutoriel, vous allez d√©couvrir comment vous connecter et cr√©er une carte.
                </br>
                Ce tutoriel est √©galement accessible √† tout moment au format PDF via le bouton "Tutoriel" dans la barre de navigation principale, ou en cliquant sur ce <a href="https://umap.datactivist.coop/media/doc/umap_tutorial_fr.pdf" target="_blank" rel="noopener">lien direct</a>.
                </br></br>

                <b>Recommandation :</b> Bien qu'il soit possible de cr√©er une carte sans compte, il est fortement conseill√© de s'identifier pour pouvoir retrouver, modifier et g√©rer ses cartes facilement.
                </br></br>
                <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                  <thead>
                    <tr style="background-color: #f0f0f0;">
                      <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Fonctionnalit√©</th>
                      <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">üë§ Utilisateur non connect√©</th>
                      <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">üîê Utilisateur connect√©</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="border: 1px solid #ddd; padding: 8px;">Cr√©ation d'une carte</td>
                      <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">‚úÖ Possible</td>
                      <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">‚úÖ Possible</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                      <td style="border: 1px solid #ddd; padding: 8px;">Sauvegarde de la carte</td>
                      <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">‚ö†Ô∏è Via un lien secret uniquement</td>
                      <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">‚úÖ Via le compte</td>
                    </tr>
                    <tr>
                      <td style="border: 1px solid #ddd; padding: 8px;">Cr√©ation d'√©quipes</td>
                      <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">‚ùå Impossible</td>
                      <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">‚úÖ Possible</td>
                    </tr>
                    <tr style="background-color: #f9f9f9;">
                      <td style="border: 1px solid #ddd; padding: 8px;">Attribution des droits d'√©dition</td>
                      <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">‚ö†Ô∏è Soit m√™me ou tout le monde</td>
                      <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">‚úÖ Personnes sp√©cifiques ou √©quipes</td>
                    </tr>
                  </tbody>
                </table>
                <i>Appuyer sur suivant pour continuer</i>`, 
                nextLabel: 'Suivant',
                anchor: "corner-bottom-left" 
              },
              { 
                selector: '#nav-login-link', 
                title: 'Se connecter', 
                text: `
                <b>Les √©tapes pour se connecter :</b>
                <ul>
                  <li>Se rendre sur <a href="https://umap.datactivist.coop/fr/">https://umap.datactivist.coop/fr/</a></li>
                  <li>Cliquer sur "Connexion / Cr√©er un compte"</li>
                  <li>Choisir une m√©thode d'authentification (openstreetmap recommand√©, vous devez cr√©er un compte openstreetmap)</li>
                  <li>Autoriser l'outil √† acc√©der √† votre compte</li>
                </ul>
                </br></br>
                <i>Pour r√©aliser l'action d√©crite, cliquez sur la fonctionnalit√© en surbrillance (cadre jaune/orange)</i>`, 
                showPrev: false,
                nextLabel: 'Continuer sans se connecter',
                anchor: "corner-bottom-left" 
              },
              { 
                selector: '.fr-search-bar', 
                title: 'Rechercher et consulter des cartes', 
                text: `
                <b>Il est possible de rechercher et de consulter les cartes cr√©√©es par la communaut√©.</b>
                </br></br>
                Les cartes explicitement configur√©es comme "visibles par tous" par le cr√©ateur sont accessibles dans cet espace. 
                <br><br>
                Au contraire, si elles ne sont pas explicitement configur√©es comme telles, l‚Äôacc√®s aux cartes sera restreint au seul cr√©ateur ou aux √©quipes pour lesquels un acc√®s explicite a √©t√© param√©tr√©. Elles ne seront pas accessibles ici, mais dans votre espace personnel accessible depuis la barre de navigation. 
                <br><br>
                Un utilisateur non connect√© peut √©galement rendre sa carte publique.
                </br></br>
                <i>Pour continuer, cliquez sur "Suivant"</i>`,
                showPrev: false,
                nextLabel: 'Suivant',
                anchor: "corner-bottom-left" 
              },
              { 
                selector: '#create-map-btn', 
                title: 'Cr√©er une carte', 
                text: `
                <b>Cliquer sur le bouton "Cr√©er une carte".</b> 
                </br> Une carte vierge s'affiche avec les contr√¥les d'√©dition activ√©s.
                </br></br>
                <i>Pour r√©aliser l‚Äôaction d√©crite, cliquez sur la fonctionnalit√© en surbrillance (cadre jaune/orange)</i>`,
                showPrev: false,
                anchor: "corner-bottom-left" 
              },
      ]


      const tutorialKey = 'umapTutorialActive'
      const endedPrefix = 'umapTutorialEnded_'
      const lastSeenKey = 'umapTutorialLastSeen_home'
      let tour = null

      // Helper: check if 24h have passed since last tutorial completion
      function shouldStartTutorial() {
        try {
          const lastSeen = localStorage.getItem(lastSeenKey)
          if (!lastSeen) return true
          const last = parseInt(lastSeen, 10)
          if (isNaN(last)) return true
          const now = Date.now()
          // 24 hours = 86400000 ms
          return (now - last) > 86400000
        } catch (err) {
          return true
        }
      }

      // Always auto-start tutorial on arrival, unless completed in last 24h
      if (shouldStartTutorial()) {
        tour = new Tutorial(steps, 'home')
        // Patch: when tutorial ends, set lastSeenKey to now
        const origEnd = tour.end.bind(tour)
        tour.end = function() {
          try { localStorage.setItem(lastSeenKey, Date.now().toString()) } catch (err) {}
          origEnd()
        }
        tour.start()
      }

      // Start tutorial button on home page: reset all per-tour ended flags,
      // set the global flag and start the home tour.
      const startBtn = document.querySelector('#start-tutorial-btn')
      if (startBtn) {
        startBtn.addEventListener('click', () => {
          try {
            // Clear all ended flags
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i)
              if (key && key.indexOf(endedPrefix) === 0) {
                localStorage.removeItem(key)
                i--
              }
            }
            localStorage.setItem(tutorialKey, '1')
            localStorage.removeItem(lastSeenKey)
          } catch (err) { console.log('[Tutorial] failed to reset flags', err) }
          if (!tour) tour = new Tutorial(steps, 'home')
          // Patch: when tutorial ends, set lastSeenKey to now
          const origEnd = tour.end.bind(tour)
          tour.end = function() {
            try { localStorage.setItem(lastSeenKey, Date.now().toString()) } catch (err) {}
            origEnd()
          }
          try { tour.start() } catch (err) { console.log('[Tutorial] failed to start', err) }
        })
      }

      // Gestion de la modal DSFR de choix du tutoriel
      const createBtn = document.querySelector('#create-map-btn')
      const createWithTutorialBtn = document.querySelector('#create-with-tutorial')
      const createWithoutTutorialBtn = document.querySelector('#create-without-tutorial')
      const mapNewUrl = '{% url "map_new" %}'

      // Le bouton ouvre la modale automatiquement via aria-controls
      // On √©coute juste le clic pour avancer le tutoriel si actif
      if (createBtn) {
        createBtn.addEventListener('click', () => {
          console.log('home: create button clicked, modal will open via DSFR')
          // Avancer le tutoriel de la home si actif
          if (tour) tour.next()
        })
      } else {
        console.log('home: create button not found')
      }

      // Cr√©er avec tutoriel
      if (createWithTutorialBtn) {
        createWithTutorialBtn.addEventListener('click', () => {
          console.log('home: creating map with tutorial')
          try {
            // Activer le tutoriel global
            localStorage.setItem(tutorialKey, '1')
            // S'assurer que le tutoriel map n'est pas marqu√© comme termin√©
            localStorage.removeItem(endedPrefix + 'map')
          } catch (err) {
            console.log('[Tutorial] failed to set tutorial flags', err)
          }
          // Rediriger vers la cr√©ation de carte
          window.location.href = mapNewUrl
        })
      }

      // Cr√©er sans tutoriel
      if (createWithoutTutorialBtn) {
        createWithoutTutorialBtn.addEventListener('click', () => {
          console.log('home: creating map without tutorial')
          try {
            // D√©sactiver le tutoriel global
            localStorage.setItem(tutorialKey, '0')
            // Marquer le tutoriel map comme termin√© pour √©viter l'auto-start
            localStorage.setItem(endedPrefix + 'map', '1')
          } catch (err) {
            console.log('[Tutorial] failed to set tutorial flags', err)
          }
          // Rediriger vers la cr√©ation de carte
          window.location.href = mapNewUrl
        })
      }
    })
  </script>
{% endblock bottom_js %}
