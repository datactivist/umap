{% extends "base.html" %}

{% load umap_tags i18n static %}

{% block head_title %}
  {{ map.name }} - {{ SITE_NAME }} - {{ SITE_DESCRIPTION }}
{% endblock head_title %}
{% block body_class %}
  map_detail{% if SIMPLIFIED_MODE %} simplified-mode{% endif %}
{% endblock body_class %}
{% block extra_head %}
  {% if preconnect_domains %}
    {% for domain in preconnect_domains %}
      <link rel="preconnect" href="{{ domain }}" />
    {% endfor %}
  {% endif %}
  {% umap_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'umap/css/tutorial.css' %}" />
  {% umap_js locale=locale %}
  {% if UMAP_DEMO_SITE or object.share_status != object.PUBLIC %}
    <meta name="robots" content="noindex,nofollow">
  {% endif %}
  <link rel="alternate"
        type="application/json+oembed"
        href="{{ oembed_absolute_uri }}?url={{ quoted_absolute_uri }}&format=json"
        title="{{ map.name }} oEmbed URL" />
  <meta property="og:url" content="{{ SITE_URL }}{{ map.get_absolute_url }}" />
  <meta property="og:title" content="{{ map.name }}" />
  <meta property="og:description" content="{{ map.description }}" />
  <meta property="og:site_name" content="{{ SITE_NAME }}" />
{% endblock extra_head %}
{% block content %}
  {% block map_init %}
    {% include "umap/map_init.html" %}
  {% endblock map_init %}
{% endblock content %}

{% block bottom_js %}
  {{ block.super }}
  <script type="module">
    import Tutorial from '{% static "umap/js/components/tutorial.js" %}'

    document.addEventListener('DOMContentLoaded', () => {

      const tutorialKey = 'umapTutorialActive'
      const endedPrefix = 'umapTutorialEnded_'
      const isActive = (() => { try { return localStorage.getItem(tutorialKey) === '1' } catch (err) { return false } })()
      if (!isActive) return
      // don't auto-start if this specific map tutorial was already ended
      const isMapEnded = (() => { try { return localStorage.getItem(endedPrefix + 'map') === '1' } catch (err) { return false } })()
      if (isMapEnded) return
      const steps = [

            {
              name: 'click-import-button',
              // topbar importers button
              selector: 'button[title="Importer des données (Ctrl+I)"]',
              title: 'Assistants d\'import',
              text: `Cliquez sur le bouton 'Importer des données (Ctrl+I)' pour ouvrir les assistants d'import.
                    </br></br>
                    <i>Pour réaliser l'action décrite, cliquez sur la fonctionnalité en surbrillance (cadre jaune/orange)</i>`,
              showNext: false,
              anchor: 'corner-bottom-left',
            },
            {
              name: 'import-file-input',
              // importer dialog - file input
              selector: '.umap-import input[type="file"]',
              title: "Importer des données locales",
              text: `La fonctionnalité Importer des données permet d'importer des données locales que l'utilisateur pourra charger depuis son disque local.
              </br></br>
              Les formats de données possibles sont <b>le geojson, le csv, le gpx, le kml, l'osm, le georss et le format umap.</b>
              </br></br>
              Pour importer un fichier csv, le fichier d'origine doit respecter les paramètres suivants :
              <ul>
                <li>- Virgule, tabulation ou point-virgule pour séparer des valeurs.</li>
                <li>- Le système de coordonnées <a href="https://epsg.io/4326" target="_blank" rel="noopener">SRS WGS84</a> est implicite.</li>
                <li>- Seuls les points géométriques sont importés. L'importation se référera au titre dans les entêtes de colonnes de «lat» et «lon» au début de l'en-tête, et est insensible à la casse. Toutes les autres colonnes sont importées en tant que propriétés.</li>
              </ul>
              </br>
              <b>Attention :</b> l'outil n'est pas un outil de géomatique, il ne permet pas de réaliser de géotraitement sur les données importées. Si vous souhaitez afficher des données comprenant une analyse, vous devez réaliser l'analyse en amont dans un logiciel du type QGis, travailler la symbologie et réaliser un export des données avec la symbologie intégrée pour ensuite l'importer dans le POC.
              </br>
              <i>Appuyer sur suivant pour continuer</i>`,
              showPrev: false,
              // style: 'padding-right: 500px;',
              anchor: 'corner-bottom-left'
            },
            {
              name: 'import-paste-textarea',
              // importer dialog - textarea
              selector: '.umap-import textarea',
              title: "Coller des données",
              text: `La fonctionnalité Coller vos données ici permet d'utiliser un simple copier/coller de vos données, les formats de données possibles sont :
              <ul>
                <li>- geojson</li>
                <li>- csv</li>
                <li>- gpx</li>
                <li>- kml</li>
              </ul>
              </br>
              Pour copier/coller un fichier csv, le fichier d'origine doit respecter les paramètres suivants :
              <ul>
                <li>- Virgule, tabulation ou point-virgule pour séparer des valeurs.</li>
                <li>- Le système de coordonnées <a href="https://epsg.io/4326" target="_blank" rel="noopener">SRS WGS84</a> est implicite.</li>
                <li>- Seuls les points géométriques sont importés. L'importation se référera au titre dans les entêtes de colonnes de «lat» et «lon» au début de l'en-tête, et est insensible à la casse. Toutes les autres colonnes sont importées en tant que propriétés.</li>
              </ul>
              </br></br>
              <b>Attention :</b> l'outil n'est pas un outil de géomatique, il ne permet pas de réaliser de géotraitement sur les données importées. Si vous souhaitez afficher des données comprenant une analyse, vous devez réaliser l'analyse en amont dans un logiciel du type QGis, travailler la symbologie et réaliser un export des données avec la symbologie intégrée pour ensuite l'importer dans le POC.
              </br>
              <i>Appuyer sur suivant pour continuer</i>`,
              showPrev: false,
              anchor: 'corner-bottom-left'
            },
            {
              name: 'import-url-input',
              // importer dialog - URL input
              selector: '.umap-import input[type="url"]',
              title: "Importer des données distantes",
              text: `Vous pouvez aussi coller l'URL de données distantes
              </br></br>
              Les formats de données possibles sont les mêmes que pour l’import local : <b>geojson, csv, gpx, kml, osm, georss, umap</b>.
              </br></br>
              Pour importer un fichier csv, le fichier d'origine doit respecter les paramètres suivants :
              <ul>
                <li>- Virgule, tabulation ou point-virgule pour séparer des valeurs.</li>
                <li>- Le système de coordonnées <a href="https://epsg.io/4326" target="_blank" rel="noopener">SRS WGS84</a> est implicite.</li>
                <li>- Seuls les points géométriques sont importés. L'importation se référera au titre dans les entêtes de colonnes de «lat» et «lon» au début de l'en-tête, et est insensible à la casse. Toutes les autres colonnes sont importées en tant que propriétés.</li>
              </ul>
              </br>
              <i>Appuyer sur suivant pour continuer</i>`,
              showPrev: false,
              anchor: 'corner-bottom-left'
            },
            {
              name: 'import-assistants-button',
              // importer dialog - importers button (assistants)
              selector: '.umap-import button.importers[data-ref="importersButton"]',
              title: "Assistants d'import",
              text: `Enfin, vous pouvez utilisez les assistants d'import pour faciliter l'import de certaines données sélectionnées.
              </br></br>
              Cliquez sur le bouton <b>Assistants d'import</b> pour ouvrir la fenêtre des assistants disponibles.
              </br>
              <i>Pour réaliser l'action décrite, cliquez sur la fonctionnalité en surbrillance (cadre jaune/orange)</i>`,
              showNext: false,
              showPrev: false,
              anchor: 'corner-bottom-left'
            },
            {
              name: 'importers-grid',
              // importer dialog
              selector: '.umap-dialog.window.importers, .importers.dialog, .umap-importers, .umap-dialog.importers',
              title: "Assistants d'import",
              text: `<b>Les assistants d'import</b> permettent de charger sur la carte des données contenues dans l'outil. Ces données sont classées selon différentes catégories :
              </br>
              <ul>
                <li>- Contours des communes</li>
                <li>- Données d'exposition (données décrivant le climat)</li>
                <li>- Données de contexte (ex : les populations)</li>
                <li>- Données bleues (données relatives à l'eau)</li>
                <li>- Données grises (données relatives au contexte urbain)</li>
                <li>- Données vertes (données relatives à la végétation)</li>
                <li>- Données issues de la base de données Openstreetmap</li>
              </ul>
              </br>
              Sélectionnez un des assistants proposés pour ouvrir la fenêtre de sélection des données.`,
              showNext: false,
              showPrev: false,
              anchor: 'corner-bottom-left'
            },
            {
              name: 'importer-specific-dialog',
              // importer-specific dialog shown after selecting a helper
              selector: '.umap-dialog.window.importer, .umap-dialog.window .importer, .importer.dialog, .overpass.importer, .datasets.importer, .geodatamine.importer',
              title: "Choisir les données",
              text: "Choisissez le jeu de données ou renseignez l'expression, puis validez en cliquant sur le bouton de confirmation.",
              showNext: false,
              showPrev: false,
              anchor: 'corner-bottom-left',
              nextLabel: 'Suivant',
            },
            {
              name: 'import-submit-button',
              // final: the import panel submit button that performs the import
              selector: '.umap-import [name="submit"], .umap-import input[name="submit"]',
              title: "Importer les données",
              text: `L'assistant a rempli automatiquement le formulaire, cliquez sur 'Importer des données' pour lancer l'import.
              </br>
              <i>Pour réaliser l'action décrite, cliquez sur la fonctionnalité en surbrillance (cadre jaune/orange)</i>`,
              showNext: false,
              showPrev: false,
              anchor: 'corner-bottom-left',
            },
            {
              name: 'caption-button',
              selector: 'li[data-ref="caption"] button, button[title="Modifier les propriétés de la carte"]',
              title: "Autres fonctionnalités",
              text: `Vous avez importé vos premières données, passons aux autres fonctionnalités.
              </br></br>
              Vous pouvez modifier les propriétés de la carte en cliquant sur le bouton "Modifier les propriétés de la carte".
              </br></br>
              <ul>
                <li>- Donner un nom descriptif à la carte</li>
                <li>- Ajouter une description</li>
                <li>- Définir la licence d'utilisation</li>
                <li>- Choisir le fond de carte approprié</li>
              </ul>
              </br>
              <i>Appuyer sur suivant pour continuer</i>`,
              anchor: 'corner-bottom-left',
              showPrev: false,
            },
            {
              name: 'tilelayers-button',
              selector: 'li[data-ref="tilelayers"] button, button[title="Changer le fond de carte"]',
              title: "Fonds de carte",
              text: `3 fonds de carte sont disponibles à ce jour dans l'outil :
              </br></br>
              <ul>
                <li>- <b>OpenStreetMap (permet d'avoir une vue cartographique de la zone (routes, bâtiments, cours d'eau, etc.)</b></li>
                <li>- <b>Images satellites (permet d'avoir une vue réelle de la zone)</b></li>
                <li>- <b>Simplifié (permet d'avoir le minimum d'informations essentielles)</b></li>
              </ul>
              </br>
              <i>Appuyer sur suivant pour continuer</i>`,
              anchor: 'corner-bottom-left',
              showPrev: false,
            },
            {
              name: 'permissions-button',
              selector: 'li[data-ref="permissions"] button, button[title="Changer les permissions et les éditeurs"]',
              title: "Permissions et partage",
              text: `<b>Type de permission</b>
              </br></br>
              <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                <thead>
                  <tr style="background-color: #f0f0f0;">
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Type</th>
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Options</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;"><b>Édition</b></td>
                    <td style="border: 1px solid #ddd; padding: 8px;">Seul le créateur / Éditeurs nommés / Tous les utilisateurs connectés / Tout le monde (anonyme)</td>
                  </tr>
                  <tr style="background-color: #f9f9f9;">
                    <td style="border: 1px solid #ddd; padding: 8px;"><b>Consultation</b></td>
                    <td style="border: 1px solid #ddd; padding: 8px;">Publique / Avec le lien seulement / Éditeurs uniquement</td>
                  </tr>
                </tbody>
              </table>
              </br>
              <b>Recommandation :</b> Pour un travail collaboratif, définir des éditeurs nommés plutôt que d'ouvrir l'édition à tous.
              </br>
              <i>Appuyer sur suivant pour continuer</i>`,
              anchor: 'corner-bottom-left',
              showPrev: false,
            },
            {
              name: 'advanced-properties-button',
              selector: 'li[data-ref="settings"] button',
              title: "Propriétés avancées de la carte",
              text: `Cliquez sur ce bouton pour ouvrir les propriétés avancées de la carte et découvrir les options d'interface.
              </br></br>
              <i>Pour réaliser l'action décrite, cliquez sur la fonctionnalité en surbrillance (cadre jaune/orange)</i>`,
              anchor: 'corner-bottom-left',
              showNext: false,
              showPrev: false,
            },
            {
              name: 'interface-options',
              selector: 'div[data-highlight="settings"] details:first-of-type summary',
              title: "Options d'interface",
              text: `Les options proposées peuvent s'afficher dans la barre d'outils verticale à gauche de la carte.
              </br></br>
              Vous pouvez choisir de les afficher :
              <ul>
                <li>- <b>Toujours</b></li>
                <li>- <b>Jamais</b></li>
                <li>- <b>Caché</b> (elles apparaissent si vous cliquez sur la petite flèche grise)</li>
              </ul>
              </br>
              <i>Appuyer sur suivant pour continuer</i>`,
              anchor: 'corner-bottom-left',
              showPrev: false,
            },
            {
              name: 'default-shape-properties',
              selector: 'div[data-highlight="settings"] details:nth-of-type(2) summary',
              title: "Propriétés de forme par défaut",
              text: `<b>Symbologie (représentation visuelle)</b>
              </br></br>
              Choisir les couleurs et les épaisseurs de traits
              </br>
              <i>Appuyer sur suivant pour continuer</i>`,
              anchor: 'corner-bottom-left',
              showPrev: false,
            },
            {
              name: 'default-interaction-options',
              selector: 'div[data-highlight="settings"] details:nth-of-type(4) summary',
              title: "Options d'interaction par défaut",
              text: `<b>Pop-ups et interactions</b>
              </br></br>
              Chaque objet peut afficher une pop-up contenant :
              <ul>
                <li>- Titre et description en texte enrichi</li>
                <li>- Images et médias</li>
                <li>- Liens hypertextes</li>
                <li>- Variables dynamiques (propriétés de l'objet)</li>
              </ul>
              </br>
              <i>Appuyer sur suivant pour continuer</i>`,
              anchor: 'corner-bottom-left',
              showPrev: false,
            },
            {
              name: 'slideshow-options',
              selector: 'div[data-highlight="settings"] details:nth-of-type(5) summary',
              title: "Diaporama",
              text: `Créer un parcours guidé à travers les différents objets de la carte avec navigation automatique.
              </br>
              <i>Appuyer sur suivant pour continuer</i>`,
              anchor: 'corner-bottom-left',
              showPrev: false,
            },
            {
              name: 'advanced-actions',
              selector: 'div[data-highlight="settings"] details:nth-of-type(6) summary',
              title: "Actions avancées",
              text: `<b>Export des données</b>
              </br></br>
              Les données de la carte peuvent être exportées dans plusieurs formats :
              <ul>
                <li>- <b>GeoJSON</b> - Format complet avec toutes les propriétés</li>
                <li>- <b>gpx</b> - Pour utilisation GPS</li>
                <li>- <b>kml</b> - Compatible Google Earth</li>
                <li>- <b>csv</b> - Format texte</li>
                <li>- <b>jpg</b> - Format image</li>
                <li>- <b>png</b> - Format image</li>
              </ul>
              </br>
              <b>Intégration dans un site web</b>
              </br></br>
              uMap génère automatiquement un code iframe pour intégrer la carte :
              <ul>
                <li>- Cliquer sur l'icône de partage</li>
                <li>- Copier le code iframe généré</li>
                <li>- Coller le code dans le HTML de votre page</li>
              </ul>
              </br>
              <b>Options d'intégration :</b>
              <ul>
                <li>- Largeur et hauteur personnalisables</li>
                <li>- Affichage du panneau latéral</li>
                <li>- Zoom initial et centrage</li>
              </ul>
              </br>
              <i>Appuyer sur suivant pour continuer</i>`,
              anchor: 'corner-bottom-left',
              showPrev: false,
            },
            {
              name: 'couche-explain',
              selector: 'button[title="Gérer les couches de données"]',
              title: "Les couches de données",
              text: `Les couches de données (ou calques) permettent d'organiser les objets géographiques de manière thématique. Chaque couche peut avoir ses propres propriétés d'affichage et de style.
              </br></br>
              <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                <thead>
                  <tr style="background-color: #f0f0f0;">
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Avantage</th>
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">Organisation</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">Séparer les données par thème pour une carte plus lisible</td>
                  </tr>
                  <tr style="background-color: #f9f9f9;">
                    <td style="border: 1px solid #ddd; padding: 8px;">Lisibilité</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">Afficher uniquement les informations pertinentes selon le besoin</td>
                  </tr>
                  <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">Flexibilité</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">Activer, désactiver ou réorganiser les couches facilement</td>
                  </tr>
                  <tr style="background-color: #f9f9f9;">
                    <td style="border: 1px solid #ddd; padding: 8px;">Edition ciblée</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">Modifier une couche sans impacter les autres</td>
                  </tr>
                  <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">Analyse</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">Croiser plusieurs couches pour révéler des relations spatiales</td>
                  </tr>
                </tbody>
              </table>
              </br></br>
              Ouvrez l'explorateur de données pour voir les couches et les jeux de données importés.
              </br></br>
              <i>Pour réaliser l'action décrite, cliquez sur la fonctionnalité en surbrillance (cadre jaune/orange)</i>`,
              anchor: 'corner-bottom-left',
              showNext: false,
              showPrev: false,
            },
            {
              name: 'edit-layer',
              // highlight the edit button for the first layer once explorer opened
              selector: '.umap-browser .feature:first-of-type .icon-edit, .umap-browser .feature:first-of-type [data-ref="edit"], .umap-panel .feature:first-of-type .icon-edit, .umap-browser li .icon-edit, .umap-browser button.icon-edit, .umap-panel button.icon-edit, ul[data-ref="ul"] li .icon-edit',
              title: "Modifier une couche de données",
              text: `Cliquez sur ce bouton pour modifier la couche que vous venez d'importer.
              </br>
              <i>Pour réaliser l'action décrite, cliquez sur la fonctionnalité en surbrillance (cadre jaune/orange)</i>`,
              anchor: 'corner-bottom-left',
              showNext: false,
              showPrev: false,
            },
            {
              name: 'layer-properties',
              // highlight the layer/feature properties popup so the
              // user sees the parameters panel. Match known containers/ids.
              selector: '#umap-feature-shape-properties, .umap-layer-properties-container, .umap-feature-container, .umap-edit-panel .umap-layer-properties-container, .umap-edit-panel #umap-feature-shape-properties',
              title: "Paramètres d'affichage",
              text: `Un onglet s'ouvre alors, regroupant les paramètres disponibles pour la couche de données.
              </br></br>
              Dans le cadre de ce tutoriel, nous nous concentrerons sur les paramètres les plus importants, mais n'hésitez pas à les explorer par vous-même : il en existe beaucoup d'autres.
              </br></br>
              <i>Cliquez sur Suivant pour continuer.</i>`,
              anchor: 'corner-bottom-left',
              showPrev: false,
            },
            {
              name: 'layer-display-type',
              selector: 'select[name="type"][data-ref="select"]',
              title: "Type d'affichage des données",
              text: `Vous pouvez modifier le type d'affichage des données selon vos besoins :
              </br></br>
              <ul>
                <li>- <b>Par défaut</b> : correspond au mode d'affichage défini lors de l'importation de la couche de données.</li>
                <li>- <b>Cluster</b> : regroupe les points géographiquement proches afin de limiter l'encombrement visuel et d'améliorer les performances.</li>
                <li>- <b>Heatmap</b> : représente la densité des données à l'aide de gradients de couleur, permettant d'identifier les zones de forte concentration.</li>
                <li>- <b>Choroplèthe</b> : affiche les données agrégées par zones géographiques avec une variation de couleur proportionnelle aux valeurs associées.</li>
                <li>- <b>Par catégories</b> : distingue les données selon une catégorie définie par l'utilisateur.</li>
                <li>- <b>Cercles proportionnels</b> : utilise des cercles dont la taille est proportionnelle à la valeur représentée, permettant une comparaison visuelle des ordres de grandeur.</li>
              </ul>
              </br>
              <b>Note :</b> Lorsque les données importées contiennent plus de 1.000 points, le mode Cluster est sélectionné par défaut afin d'optimiser les performances et la lisibilité de la carte.
              </br></br>
              <i>Cliquez sur Suivant pour continuer.</i>`,
              anchor: 'corner-bottom-left',
              showPrev: false,
            },
            {
              name: 'layer-semiologie',
              selector: '',
              title: "Sémiologie - Styles des objets",
              text: `<b>Styles des objets</b>
              </br></br>
              Pour chaque objet ou calque dont les objets géographiques sont des points, il est possible de personnaliser :
              </br></br>
              <ul>
                <li>- <b>Couleurs</b> : Contour et remplissage</li>
                <li>- <b>Icônes</b> : Bibliothèque extensive d'icônes pour les marqueurs</li>
                <li>- <b>Opacité</b> : Transparence des objets</li>
                <li>- <b>Épaisseur</b> : Largeur des lignes</li>
                <li>- <b>Formes</b> : Style des marqueurs (épingle, cercle, etc.)</li>
              </ul>
              </br>
              Il est également possible d'ajouter une icône personnalisée via une URL externe. (attention d'utiliser une URL stable afin de ne pas perdre le lien)
              </br></br>
              <i>Cliquez sur Suivant pour continuer.</i>`,
              anchor: 'corner-bottom-left',
              showPrev: false,
            },
            {
              name: 'layer-popup-interactions',
              selector: '',
              title: "Pop-ups et interactions",
              text: `<b>Pop-ups et interactions</b>
              </br></br>
              Vous pouvez modifier le comportement et l'apparence de ce pop-up depuis l'onglet "Options d'interaction"
              </br></br>
              Chaque objet peut afficher une popup contenant :
              </br></br>
              <ul>
                <li>- Titre et description en texte enrichi</li>
                <li>- Images et médias</li>
                <li>- Liens hypertextes</li>
                <li>- Variables dynamiques (propriétés de l'objet)</li>
              </ul>
              </br></br>
              <i>Cliquez sur Suivant pour continuer.</i>`,
              anchor: 'corner-bottom-left',
              showPrev: false,
            },
            {
              name: 'tutorial-ended',
              selector: '',
              title: "Tutoriel terminé",
              text: `Le tutoriel est terminé, vous pouvez le télécharger au format PDF sur le lien suivant : xxx
              </br></br>
              N'hésitez pas à consulter les boutons d'aides <span style="display:inline-block; width:16px; height:16px; background-color:#0078D7; color:white; border-radius:50%; text-align:center; line-height:16px; font-size:12px; font-weight:bold;">?</span> répartis dans l'interface pour obtenir des informations contextuelles.`,
              anchor: 'corner-bottom-left',
              showPrev: false,
              doneLabel: "Terminer le tutoriel",
            },
      ]

      const tour = new Tutorial(steps, 'map')
      tour.start()

      // Debounced advance helper: prevents multiple quick calls from
      // advancing the tour more than once (race between click and alert).
      let _advanceLocked = false;
      const advanceOnce = () => {
        if (_advanceLocked) return;
        _advanceLocked = true;
        try {
          if (tour.index < (steps.length - 1)) tour.next();
        } catch (err) { console.log('[Tutorial] advanceOnce failed', err); }
        setTimeout(() => { _advanceLocked = false }, 700);
      }

      // When the importers button is clicked, advance the tour to the next step
      // can highlight the importer dialog. The bar registers its own click
      // handlers; we just listen for clicks and advance the tour when needed.
      const importBtn = document.querySelector('.umap-main-edit-toolbox .importers, .umap-main-edit-toolbox [data-ref="importersButton"]')
      if (importBtn) {
        importBtn.addEventListener('click', () => {
          // Only advance if we're on the click-import-button step
          if (tour.isCurrentStep('click-import-button')) {
            // Small timeout to let the importer dialog render
            setTimeout(() => {
              advanceOnce()
            }, 250)
          }
        })
      }

      // Listen for the new layers button (li[data-ref="layers"] button) to advance the tutorial
      const attachLayersHandler = () => {
        try {
          const layersBtn = document.querySelector('li[data-ref="layers"] button')
          if (layersBtn && !layersBtn.__tutorialBound) {
            layersBtn.addEventListener('click', () => {
              try {
                // Advance from couche-explain to couche-explain when button is clicked
                if (tour.isCurrentStep('couche-explain')) {
                  tour.advanceIfCurrentStep('couche-explain')
                }
                // Or advance from couche-explain to edit-layer
                else if (tour.isCurrentStep('couche-explain')) {
                  tour.advanceIfCurrentStep('couche-explain')
                }
              } catch (err) { console.log('[Tutorial] layersBtn advance failed', err) }
            })
            layersBtn.__tutorialBound = true
          }
        } catch (err) { /* ignore */ }
      }
      attachLayersHandler()
      // fallback: watch for layers button insertion
      const layersMo = new MutationObserver((mutations) => { attachLayersHandler() })
      layersMo.observe(document.body, { childList: true, subtree: true })

      // Listen for the assistants button inside .umap-import to advance from
      // import-assistants-button to importers-grid
      const attachAssistantsHandler = () => {
        try {
          const assistantsBtn = document.querySelector('.umap-import button.importers[data-ref="importersButton"]')
          if (assistantsBtn && !assistantsBtn.__tutorialAssistantsBound) {
            assistantsBtn.addEventListener('click', () => {
              try {
                // Only advance if we're on the import-assistants-button step
                if (tour.isCurrentStep('import-assistants-button')) {
                  setTimeout(() => {
                    advanceOnce()
                  }, 150)
                }
              } catch (err) { console.log('[Tutorial] assistantsBtn advance failed', err) }
            })
            assistantsBtn.__tutorialAssistantsBound = true
          }
        } catch (err) { /* ignore */ }
      }
      attachAssistantsHandler()
      // fallback: watch for assistants button insertion
      const assistantsMo = new MutationObserver((mutations) => { attachAssistantsHandler() })
      assistantsMo.observe(document.body, { childList: true, subtree: true })

      // Delegated click handler: when a helper button in the importers grid
      // is clicked (including clicks on inner icons/labels), the
      // importer-specific dialog will open; advance the tour. Use
      // closest() to find button/link ancestors and verify they're inside
      // a known importers grid/dialog container before advancing.
      document.addEventListener('click', (e) => {
        // only act when we're on the importers-grid step
        if (!tour.isCurrentStep('importers-grid')) return
        // find the nearest actionable element (button/link)
        const actionEl = e.target && e.target.closest && e.target.closest('button, a, [role="button"]')
        if (!actionEl) return
        // confirm the actionable element is inside an importer grid/dialog
        const gridContainer = actionEl.closest && actionEl.closest('.umap-dialog.window.importers, .importers.dialog, .umap-importers, .umap-dialog.importers, [data-ref="grid"], .grid-container')
        if (gridContainer) {
          // tiny delay to let the importer.open() process and dialog content update
          setTimeout(() => {
            tour.advanceIfCurrentStep('importers-grid')
          }, 80)
        }
      })

      // If the importer dialog is opened by other means (keyboard shortcut),
      // detect its appearance and advance the tour to the importer step.
      const observer = new MutationObserver((mutations) => {
        for (const m of mutations) {
          for (const node of m.addedNodes) {
            if (!(node instanceof HTMLElement)) continue
            // Check for the main import panel (.umap-import)
            if (node.matches && node.matches('.umap-import')) {
              tour.advanceIfCurrentStep('click-import-button')
            }
            // Also check if the node contains .umap-import
            if (node.querySelector && node.querySelector('.umap-import')) {
              tour.advanceIfCurrentStep('click-import-button')
            }
            // Check for importers grid fieldset (assistants page) - only advance if on import-assistants-button
            if (tour.isCurrentStep('import-assistants-button')) {
              if (node.matches && node.matches('fieldset[data-ref="fieldset"]')) {
                const gridEl = node.querySelector && node.querySelector('.grid-container, [data-ref="grid"]')
                if (gridEl) {
                  advanceOnce()
                  return
                }
              }
              // Also check if node contains the importers grid
              if (node.querySelector && node.querySelector('fieldset[data-ref="fieldset"] .grid-container, fieldset[data-ref="fieldset"] [data-ref="grid"]')) {
                advanceOnce()
                return
              }
              // Check for the importers dialog container
              if (node.matches && node.matches('.umap-dialog.window.importers, .importers.dialog, .umap-importers, .umap-dialog.importers')) {
                advanceOnce()
                return
              }
            }
            // importer-specific dialog (opened after selecting a helper) - only detect if on importers-grid step
            if (tour.isCurrentStep('importers-grid')) {
              if (node.matches && node.matches('.umap-dialog.window.importer, .umap-dialog.window .importer, .importer.dialog')) {
                // Make sure it's not the importers grid itself
                if (!node.matches('.umap-dialog.window.importers, .importers.dialog, .umap-importers, .umap-dialog.importers')) {
                  advanceOnce()
                  return
                }
              }
              // Check for specific importer classes
              if (node.matches && node.matches('.overpass.importer, .datasets.importer, .geodatamine.importer, .communesfr.importer')) {
                advanceOnce()
                return
              }
            }
          }
        }
      })
      // Also observe for nodes added inside existing dialogs: some importers
      const innerObserver = new MutationObserver((mutations) => {
        for (const m of mutations) {
          // if content was added to a dialog template while we're on importers-grid step
          if (!tour.isCurrentStep('importers-grid')) continue
          for (const node of m.addedNodes) {
            if (!(node instanceof HTMLElement)) continue
            // check for importer-specific markers
            if (node.matches('.importer, .overpass, .datasets, .geodatamine') || node.querySelector && node.querySelector('.importer, .overpass, .datasets, .geodatamine')) {
              advanceOnce()
              return
            }
          }
        }
      })
      // Observe body subtree for added/changed nodes (limit to subtree already)
      innerObserver.observe(document.body, { childList: true, subtree: true })
      observer.observe(document.body, { childList: true, subtree: true })

      // Watcher: when we reach importer-specific dialog step, wait
      // for the helper to populate the import panel (URL or enabled submit) and
      // then advance the tour to highlight the import button.
      let _importPopulatePoll = null
      const startImportPopulateWatcher = () => {
        if (_importPopulatePoll) return
        _importPopulatePoll = setInterval(() => {
          // stop if user left the importer-specific-dialog step
          if (!tour.isCurrentStep('importer-specific-dialog')) {
            clearInterval(_importPopulatePoll)
            _importPopulatePoll = null
            return
          }
          const urlInput = document.querySelector('.umap-import [type="url"], .umap-import input[type="url"]')
          const submitBtn = document.querySelector('.umap-import [name="submit"], .umap-import input[name="submit"]')
          if ((urlInput && urlInput.value) || (submitBtn && !submitBtn.disabled)) {
            clearInterval(_importPopulatePoll)
            _importPopulatePoll = null
            // Advance to the import submit button step
            advanceOnce()
          }
        }, 150)
      }

      // Start watcher when the tour reaches importer-specific-dialog step
      const tourIndexChecker = setInterval(() => {
        if (tour.isCurrentStep('importer-specific-dialog')) startImportPopulateWatcher()
      }, 200)

      // Advance to couche-explain step when the user clicks the import submit button.
      document.addEventListener('click', (e) => {
        const btn = e.target.closest && e.target.closest('.umap-import [name="submit"], .umap-import input[name="submit"]')
        if (btn && tour.isCurrentStep('import-submit-button')) {
          // Don't advance here - let the success alert handle it
          // This prevents double-advancing
        }
      })

      // Also advance when an import success alert is emitted by importer.
      // Alerts are dispatched as CustomEvents 'umap:alert' from uMapAlert.emit
      const onAlert = (event) => {
        const { level = 'info', message = '' } = event.detail || {}
        // consider success-level alerts only
        if (level === 'success') {
          // Advance from import-submit-button to caption-button
          try {
            tour.advanceIfCurrentStep('import-submit-button')
          } catch (err) { console.log('[Tutorial] onAlert advance failed', err) }
        }
      }
      document.addEventListener('umap:alert', onAlert)

      // Attach handler to settings button: when clicked on advanced-properties-button step,
      // wait for the settings panel to appear, then advance to interface-options step
      const attachSettingsHandler = () => {
        try {
          const settingsBtn = document.querySelector('li[data-ref="settings"] button')
          if (settingsBtn && !settingsBtn.__tutorialSettingsBound) {
            settingsBtn.addEventListener('click', () => {
              if (tour.isCurrentStep('advanced-properties-button')) {
                // Wait for the settings panel to appear
                setTimeout(() => {
                  const settingsPanel = document.querySelector('div[data-highlight="settings"]')
                  if (settingsPanel) {
                    advanceOnce()
                  }
                }, 150)
              }
            })
            settingsBtn.__tutorialSettingsBound = true
          }
        } catch (err) { /* ignore */ }
      }
      attachSettingsHandler()

      // Also observe for the settings panel appearing (in case it's opened by other means)
      const settingsObserver = new MutationObserver((mutations) => {
        if (!tour.isCurrentStep('advanced-properties-button')) return
        for (const m of mutations) {
          for (const node of m.addedNodes) {
            if (!(node instanceof HTMLElement)) continue
            // Check if this is the settings panel
            if (node.matches && node.matches('div[data-highlight="settings"]')) {
              advanceOnce()
              return
            }
            // Also check if node contains the settings panel
            if (node.querySelector && node.querySelector('div[data-highlight="settings"]')) {
              advanceOnce()
              return
            }
          }
        }
      })
      settingsObserver.observe(document.body, { childList: true, subtree: true })

      // Listen for clicks on the edit button in the browser list. When the
      // user clicks edit for the first layer on the edit-layer step,
      // advance to the final layer-properties step.
      const editSelector = '.umap-browser .feature:first-of-type .icon-edit, .umap-browser .feature:first-of-type [data-ref="edit"], .umap-panel .feature:first-of-type .icon-edit, .umap-browser li .icon-edit, .umap-browser button.icon-edit, .umap-panel button.icon-edit, ul[data-ref="ul"] li .icon-edit'
      const attachEditHandler = () => {
        try {
          const editBtn = document.querySelector(editSelector)
          if (editBtn && !editBtn.__tutorialEditBound) {
            editBtn.addEventListener('click', () => {
              try {
                // If we're currently on the edit-layer step, advance to layer-properties
                tour.advanceIfCurrentStep('edit-layer')
              } catch (err) { console.log('[Tutorial] editBtn advance failed', err) }
            })
            editBtn.__tutorialEditBound = true
          }
        } catch (err) { /* ignore */ }
      }
      attachEditHandler()
      // fallback: observe DOM for edit button insertion
      const editMo = new MutationObserver(() => { attachEditHandler() })
      editMo.observe(document.body, { childList: true, subtree: true })

    })
  </script>
{% endblock bottom_js %}
